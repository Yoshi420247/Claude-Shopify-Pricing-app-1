name: Batch Price Analysis

on:
  workflow_dispatch:
    inputs:
      vendor:
        description: 'Vendor/brand name to filter (leave empty for ALL vendors)'
        required: false
        type: string
        default: ''
      status:
        description: 'Product status filter'
        required: true
        type: choice
        options:
          - active
          - draft
          - all
        default: 'active'
      concurrency:
        description: 'Number of parallel workers (recommended: 50-200)'
        required: true
        type: string
        default: '100'
      search_mode:
        description: 'Web search provider for competitor research'
        required: true
        type: choice
        options:
          - openai
          - brave
          - none
        default: 'openai'
      limit:
        description: 'Max variants to process (0 = no limit)'
        required: false
        type: string
        default: '0'
      skip_analyzed:
        description: 'Skip already-analyzed products (only process new/unanalyzed)'
        required: true
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (analyze only, do NOT apply prices)'
        required: true
        type: boolean
        default: false
      markup:
        description: 'Simple cost markup multiplier (e.g. 3 = 3x cost). Skips AI â€” no OpenAI costs.'
        required: false
        type: string
        default: ''
      failed_report:
        description: 'Re-run failed products from report file (e.g. failed-products-2026-02-06-21-29-46.json)'
        required: false
        type: string
        default: ''

jobs:
  analyze:
    name: Run Batch Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours max (should finish in ~30min with 100 workers)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run batch analysis
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
          SHOPIFY_STORE_NAME: ${{ secrets.SHOPIFY_STORE_NAME }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
          # Increase Node.js memory for high concurrency
          NODE_OPTIONS: '--max-old-space-size=4096'
        run: |
          ARGS="--status ${{ inputs.status }} --concurrency ${{ inputs.concurrency }} --search-mode ${{ inputs.search_mode }}"

          if [ -n "${{ inputs.failed_report }}" ]; then
            # Re-run mode: only process previously failed products
            ARGS="--failed-report ${{ inputs.failed_report }} --concurrency ${{ inputs.concurrency }} --search-mode ${{ inputs.search_mode }}"
          else
            if [ -n "${{ inputs.vendor }}" ]; then
              ARGS="$ARGS --vendor \"${{ inputs.vendor }}\""
            fi

            if [ "${{ inputs.limit }}" != "0" ] && [ -n "${{ inputs.limit }}" ]; then
              ARGS="$ARGS --limit ${{ inputs.limit }}"
            fi
          fi

          if [ "${{ inputs.skip_analyzed }}" = "true" ]; then
            ARGS="$ARGS --skip-analyzed"
          fi

          if [ -n "${{ inputs.markup }}" ]; then
            ARGS="$ARGS --markup ${{ inputs.markup }}"
          fi

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi

          echo "Running: npx tsx --tsconfig tsconfig.scripts.json scripts/batch-analyze.ts $ARGS"
          eval npx tsx --tsconfig tsconfig.scripts.json scripts/batch-analyze.ts $ARGS

      - name: Upload failed products report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: failed-products-report
          path: reports/failed-products-*.json
          if-no-files-found: ignore
          retention-days: 30
